---
# secured workflow to analyze results from insecure 'ci' workflow that
# builds and test the project.
name: post
on:
  workflow_run:
    workflows:
      - test
    types:
      - completed
permissions:
  actions: read
  checks: read
  contents: read
  pull-requests: read
  statuses: write
jobs:
  autofix:
    name: autofix
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Checkout code from triggering run
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch }}
          repository: ${{ github.event.workflow_run.head_repository.full_name }}

      - name: Download artifact autofix-patch
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: autofix-patch
          path: autofix.patch
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply patch and push if present
        env:
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          PATCH_FILE=$(find autofix.patch -type f -name '*.patch' 2>/dev/null | head -1)
          if [ -z "$PATCH_FILE" ]; then
            echo "No autofix patch found, skipping."
            exit 0
          fi
          git config user.email ansible-devtools@redhat.com
          git config user.name "Ansible DevTools"
          git am --no-gpg-sign < "$PATCH_FILE" || exit 1
          git push origin HEAD:"${HEAD_BRANCH}" || {
            echo "::error::Push failed. Please either allow maintainers to push to your branch (e.g. enable \"Allow edits from maintainers\" on the PR), or run \`prek run -a\` locally and ensure it passes, then push yourself."
            exit 1
          }
  sonar:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Debug
        run: |
          cat <<EOF
          ${{ github.event.workflow_run }}
          EOF

      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}
          repository: ${{ github.event.workflow_run.head_repository.full_name }}

      - name: Download artifacts (coverage reports)
        id: download-coverage
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: logs.zip
          path: .git/coverage
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fail if no coverage reports are found
        run: |
          if ! find . -name 'coverage.xml' -print -quit | grep -q .; then
            echo "::error::No coverage.xml found. Sonar expects coverage (sonar.python.coverage.reportPaths=**/coverage.xml)."
            exit 1
          fi

      - name: Get PR context
        # Source: https://github.com/orgs/community/discussions/25220#discussioncomment-11316244
        id: pr-context
        if: github.event.workflow_run.event == 'pull_request'
        env:
          # Token required for GH CLI:
          GH_TOKEN: ${{ github.token }}
          # Best practice for scripts is to reference via ENV at runtime. Avoid using the expression syntax in the script content directly:
          PR_TARGET_REPO: ${{ github.repository }}
          # If the PR is from a fork, prefix it with `<owner-login>:`, otherwise only the PR branch name is relevant:
          PR_BRANCH: |-
            ${{
              (github.event.workflow_run.head_repository.owner.login != github.event.workflow_run.repository.owner.login)
                && format('{0}:{1}', github.event.workflow_run.head_repository.owner.login, github.event.workflow_run.head_branch)
                || github.event.workflow_run.head_branch
            }}
        # Query the PR number by repo + branch, then assign to step output:
        run: |
          gh pr view --repo "${PR_TARGET_REPO}" "${PR_BRANCH}" \
              --json 'number,baseRefName' --jq '"number=\(.number)\nbase_ref=\(.baseRefName)"' \
              >> "${GITHUB_OUTPUT}"

      - name: SonarCloud scan
        # Coverage processing if js map files are not present so we cannot do
        # this from inside 'check' job.
        uses: SonarSource/sonarqube-scan-action@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets[format('{0}', vars.SONAR_TOKEN_SECRET_NAME)] }}
        with:
          args: >
            ${{ env.SONAR_ARGS }}
            -Dsonar.pullrequest.base=${{ steps.pr-context.outputs.base_ref }}
            -Dsonar.pullrequest.branch=${{ steps.pr-context.outputs.pr_branch }}
            -Dsonar.pullrequest.key=${{ steps.pr-context.outputs.number }}
            -Dsonar.qualitygate.timeout=300
            -Dsonar.qualitygate.wait=true
            -Dsonar.scm.revision=${{ github.event.workflow_run.head_sha }}
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.verbose=${{ secrets.ACTIONS_STEP_DEBUG }}
